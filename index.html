<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Android Log Analyzer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">

  <div class="container py-5">
    <h2 class="text-center mb-4 text-primary">ðŸ“± Android Log Analyzer</h2>

    <div class="mb-3">
      <input type="file" id="logfile" accept=".txt,.log" class="form-control" />
    </div>
    <div class="mb-3 text-center">
      <button onclick="analyzeLog()" class="btn btn-success">Analyze Log</button>
      <button onclick="downloadCSV()" id="exportBtn" class="btn btn-outline-primary ms-2 d-none">Download CSV</button>
    </div>

    <div id="summary" class="alert alert-info d-none"></div>
    <canvas id="chart" height="100" class="my-4"></canvas>

    <table class="table table-bordered table-sm mt-4 d-none" id="logTable">
      <thead class="table-secondary">
        <tr>
          <th scope="col">Error Type</th>
          <th scope="col">Message</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    let parsedResults = [];

    const patterns = {
      anr: /ANR in .*\\nReason: .*\\n/,
      crash: /FATAL EXCEPTION: .*?\\n.*?\\n(\\w+\\.[\\w\\.]+Exception|Error): .*/s,
      oom: /OutOfMemoryError:.*/i,
      native: /signal \\d+ \\((SIG[A-Z]+)\\), code \\d+.*fault addr.*/i,
      network: /java\\.net\\.[\\w]+Exception: .*/i,
      sqlite: /SQLiteException: .*/i,
      strict: /StrictMode policy violation.*?: .*/i,
      security: /SecurityException: .*/i,
    };

    function analyzeLog() {
      const fileInput = document.getElementById("logfile");
      if (!fileInput.files[0]) return alert("Please upload a log file.");

      const reader = new FileReader();
      reader.onload = function (e) {
        const text = e.target.result;
        const lines = text.split(/\\r?\\n/);
        const result = [];

        for (let i = 0; i < lines.length; i++) {
          const chunk = lines.slice(i, i + 10).join('\\n');
          for (const [type, regex] of Object.entries(patterns)) {
            const match = chunk.match(regex);
            if (match) {
              result.push({ type: type.toUpperCase(), message: match[0].trim() });
              break;
            }
          }
        }

        parsedResults = result;
        updateUI(result);
      };

      reader.readAsText(fileInput.files[0]);
    }

    function updateUI(data) {
      const summary = document.getElementById("summary");
      const exportBtn = document.getElementById("exportBtn");
      const table = document.getElementById("logTable");
      const tbody = table.querySelector("tbody");

      if (data.length === 0) {
        summary.classList.remove("d-none");
        summary.classList.replace("alert-info", "alert-warning");
        summary.innerText = "No known issues found in the log.";
        return;
      }

      // Count by type
      const counts = {};
      data.forEach((d) => {
        counts[d.type] = (counts[d.type] || 0) + 1;
      });

      // Show summary
      summary.classList.remove("d-none");
      summary.classList.replace("alert-warning", "alert-info");
      summary.innerHTML = Object.entries(counts).map(([k, v]) => `<strong>${k}</strong>: ${v}`).join(" | ");

      // Show pie chart
      const chartEl = document.getElementById("chart");
      if (window.issueChart) window.issueChart.destroy();
      window.issueChart = new Chart(chartEl, {
        type: "pie",
        data: {
          labels: Object.keys(counts),
          datasets: [{ data: Object.values(counts), backgroundColor: ["#dc3545", "#ffc107", "#0d6efd", "#20c997", "#6f42c1"] }]
        }
      });

      // Show table
      tbody.innerHTML = "";
      data.forEach((d) => {
        const row = `<tr><td>${d.type}</td><td>${d.message.replace(/\\n/g, '<br>')}</td></tr>`;
        tbody.insertAdjacentHTML("beforeend", row);
      });

      table.classList.remove("d-none");
      exportBtn.classList.remove("d-none");
    }

    function downloadCSV() {
      if (!parsedResults.length) return;

      let csv = "Type,Message\\n";
      parsedResults.forEach((r) => {
        csv += `"${r.type}","${r.message.replace(/"/g, '""').replace(/\\n/g, ' ')}"\\n`;
      });

      const blob = new Blob([csv], { type: "text/csv" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "android_log_report.csv";
      link.click();
    }
  </script>

</body>
</html>
